// Prisma Schema for ESS Portal

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Example User model - modify according to your needs
model User {
  id           String  @id @default(uuid())
  employeeCode String  @unique
  username     String  @unique
  email        String? @unique
  mobile       String?

  tenantId     String
  branchId     String
  departmentId String
  roleId       String
  managerId    String?

  passwordHash        String
  passwordChangedAt   DateTime?
  firstLogin          Boolean   @default(true)
  isActive            Boolean   @default(true)
  isLocked            Boolean   @default(false)
  failedLoginAttempts Int       @default(0)
  lastLoginAt         DateTime?
  lastLoginIp         String?

  fullName        String
  profileImageUrl String?
  designation     String?
  joiningDate     DateTime?

  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?

  manager      User?  @relation("UserManager", fields: [managerId], references: [id])
  subordinates User[] @relation("UserManager")
  Role         Role   @relation(fields: [roleId], references: [id])
  leaveApplications LeaveApplication[]
  leaveBalances     LeaveBalance[]
  attendances       Attendance[]

  @@index([tenantId])
  @@index([branchId])
  @@index([departmentId])
  @@index([roleId])
}

model Role {
  id           String  @id @default(uuid())
  name         String
  code         String  @unique
  description  String?
  isSystemRole Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users         User[]
  leavePolicies RoleLeavePolicy[]

  @@index([code])
  @@index([isSystemRole])
}

model Department {
  id        String  @id @default(uuid())
  tenantId  String
  branchId  String
  name      String
  code      String
  managerId String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([branchId])
  @@index([managerId])
  @@index([isActive])
  @@index([tenantId, branchId])
}

model Shift {
  id       String @id @default(uuid())
  tenantId String
  name     String
  code     String

  startTime    DateTime
  endTime      DateTime
  graceMinutes Int      @default(0)
  breakMinutes Int      @default(0)

  isRotational Boolean @default(false)
  isActive     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
  @@index([isRotational])
}

model LeaveType {
  id       String @id @default(uuid())
  tenantId String
  name     String
  code     String

  defaultDays         Int
  carryForwardAllowed Boolean @default(false)
  maxCarryForward     Int?
  encashmentAllowed   Boolean @default(false)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaveApplications LeaveApplication[]
  rolePolicies      RoleLeavePolicy[]
  leaveBalances     LeaveBalance[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
}

enum AccrualType {
  ANNUAL
  MONTHLY
  PRORATED
}

model RoleLeavePolicy {
  id          String @id @default(uuid())
  roleId      String
  leaveTypeId String

  annualQuota Int
  accrualType AccrualType

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role      Role      @relation(fields: [roleId], references: [id])
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([roleId, leaveTypeId])
  @@index([roleId])
  @@index([leaveTypeId])
  @@index([isActive])
}

enum HolidayType {
  ORGANIZATION
  LOCATION
}

model Holiday {
  id       String  @id @default(uuid())
  tenantId String
  branchId String?

  name String
  date DateTime
  type HolidayType

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([branchId])
  @@index([date])
  @@index([type])
  @@index([tenantId, branchId, date])
}

model Designation {
  id       String @id @default(uuid())
  tenantId String
  name     String
  code     String

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([isActive])
}

// Attendance Models

enum AttendanceStatus {
  PENDING
  CHECKED_IN
  CHECKED_OUT
  ON_LEAVE
}

enum AttendanceLogType {
  IN
  OUT
}

model Attendance {
  id       String @id @default(uuid())
  userId   String
  date     DateTime @db.Date
  shiftId  String?
  leaveApplicationId String?

  checkInAt  DateTime?
  checkOutAt DateTime?
  status     AttendanceStatus @default(PENDING)

  isLate       Boolean @default(false)
  workMinutes  Int     @default(0)
  geoMismatch  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs AttendanceLog[]
  user User @relation(fields: [userId], references: [id])
  leaveApplication LeaveApplication? @relation(fields: [leaveApplicationId], references: [id])

  // ⚠️ TESTING MODE: Unique constraint disabled to allow multiple check-ins per day
  // @@unique([userId, date])
  
  @@index([userId])
  @@index([date])
  @@index([status])
  @@index([userId, date])
}

model AttendanceLog {
  id           String            @id @default(uuid())
  attendanceId String
  type         AttendanceLogType

  timestamp  DateTime
  latitude   String?
  longitude  String?
  photoUrl   String?
  deviceInfo String?
  ipAddress  String?

  createdAt DateTime @default(now())

  attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId])
  @@index([type])
  @@index([timestamp])
}

// Shift Assignment Status Enum
enum ShiftAssignmentStatus {
  PENDING
  APPROVED
  REJECTED
}

// Shift Assignment Model (Transaction Table)
model ShiftAssignment {
  id       String   @id @default(uuid())
  userId   String
  shiftId  String
  date     DateTime @db.Date

  status          ShiftAssignmentStatus @default(PENDING)
  requestedBy     String
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Ensure one unique shift type per user per day
  @@unique([userId, date, shiftId])
  @@index([userId])
  @@index([shiftId])
  @@index([date])
  @@index([status])
  @@index([userId, date])
  @@index([status, date])
}

// Leave Management Enums

enum HalfDayType {
  FIRST_HALF
  SECOND_HALF
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Leave Application Model
model LeaveApplication {
  id          String      @id @default(uuid())
  userId      String
  leaveTypeId String

  startDate   DateTime    @db.Date
  endDate     DateTime    @db.Date
  halfDayType HalfDayType?
  totalDays   Float
  reason      String
  year        Int

  status LeaveStatus @default(PENDING)

  // Application tracking
  appliedAt DateTime @default(now())

  // Approval tracking
  approvedBy String?
  approvedAt DateTime?

  // Rejection tracking
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // Cancellation tracking
  cancelledAt DateTime?
  cancelledBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])
  attendances Attendance[]

  @@index([userId])
  @@index([leaveTypeId])
  @@index([status])
  @@index([year])
  @@index([userId, status])
  @@index([userId, year])
  @@index([startDate, endDate])
}

// Leave Balance Model
model LeaveBalance {
  id          String @id @default(uuid())
  userId      String
  leaveTypeId String
  year        Int

  allocated    Float @default(0)
  used         Float @default(0)
  carryForward Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id])
  leaveType LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([userId, leaveTypeId, year])
  @@index([userId])
  @@index([leaveTypeId])
  @@index([year])
  @@index([userId, year])
}
